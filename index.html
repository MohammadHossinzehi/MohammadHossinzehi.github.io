<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Repair Shack Quotes</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Roboto+Mono:wght@400&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="icon" href="favicon.png" type="image/png" />
  </head>
  <body>
    <h1>Repair Shack Quotes</h1>
    <div class="container">
      <div class="form-container">
        <form id="productForm">
          <label for="model">Model:</label>
          <input type="text" id="model" name="model" required /><br />
          <label for="repair">Repair:</label>
          <input type="text" id="repair" name="repair" required /><br />
          <label for="price">Price:</label>
          <input type="text" id="price" name="price" required /><br />
          <button type="submit" id="submit">Submit</button>
        </form>
        <div class="clear-container" style="margin-top: 50px">
          <form id="clearForm">
            <label for="id">ID Number to Delete:</label>
            <input type="text" id="id" name="id" required />
            <button type="submit" class="clear">Delete</button>
          </form>
        </div>
      </div>

      <div class="table-container">
        <table id="responseTable">
          <thead>
            <tr>
              <th>ID Number</th>
              <th>Model</th>
              <th>Repair</th>
              <th>Price</th>
              <th>Time</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            <!-- Data will be inserted here -->
          </tbody>
        </table>
      </div>
    </div>
    <script>
      // Function to format time by removing seconds
      function formatTimeWithoutSeconds(timeWithSeconds) {
        const [hoursMinutes, ampm] = timeWithSeconds.split(" ");
        const [hours, minutes] = hoursMinutes.split(":");
        return `${hours}:${minutes} ${ampm}`;
      }

      // Function to fetch data from the API
      async function fetchData() {
        try {
          const response = await fetch(
            "https://9j78inyh6g.execute-api.us-east-1.amazonaws.com/dev",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ type: "startup" }), // Specify type as startup
            }
          );

          const result = await response.json();
          const body = JSON.parse(result.body);
          let fileContent = body.fileContent;

          // Split the content into lines and reverse the order
          const lines = fileContent.split("\n").reverse();

          // Clear the table body
          const tableBody = document.querySelector("#responseTable tbody");
          tableBody.innerHTML = "";

          // Populate the table
          lines.forEach((line) => {
            if (line.trim()) {
              // Skip empty lines
              const [id, date, model, price, repair] = line.split(",");
              const displayId = id ? id : "***"; // Display '***' if id is missing
              if (date && model && price && repair) {
                const [datePart, timeWithSeconds] = date.split(" ");
                const formattedTime = formatTimeWithoutSeconds(
                  `${timeWithSeconds} ${date.split(" ")[2]}`
                ); // Remove seconds and keep AM/PM
                const row = document.createElement("tr");
                row.innerHTML = `
                  <td>${displayId}</td>
                  <td>${model}</td>
                  <td>${repair}</td>
                  <td>${price}</td>
                  <td>${formattedTime}</td>
                  <td>${datePart}</td>
                `;
                tableBody.appendChild(row);
              }
            }
          });
        } catch (error) {
          console.error("Error:", error);
          document.querySelector("#responseTable tbody").innerHTML =
            "<tr><td colspan='6'>Failed to fetch data</td></tr>";
        }
      }

      // Form submission handler for adding products
      document
        .getElementById("productForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();

          const model = document.getElementById("model").value;
          const price = document.getElementById("price").value;
          const repair = document.getElementById("repair").value;

          try {
            const response = await fetch(
              "https://9j78inyh6g.execute-api.us-east-1.amazonaws.com/dev",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  type: "submitProduct",
                  model,
                  price,
                  repair,
                }), // Specify type as submitProduct
              }
            );

            const result = await response.json();
            const body = JSON.parse(result.body);
            let fileContent = body.fileContent;

            // Split the content into lines and reverse the order
            const lines = fileContent.split("\n").reverse();

            // Clear the table body
            const tableBody = document.querySelector("#responseTable tbody");
            tableBody.innerHTML = "";

            // Populate the table
            lines.forEach((line) => {
              if (line.trim()) {
                // Skip empty lines
                const [id, date, model, price, repair] = line.split(",");
                const displayId = id ? id : "***"; // Display '***' if id is missing
                if (date && model && price && repair) {
                  const [datePart, timeWithSeconds] = date.split(" ");
                  const formattedTime = formatTimeWithoutSeconds(
                    `${timeWithSeconds} ${date.split(" ")[2]}`
                  ); // Remove seconds and keep AM/PM
                  const row = document.createElement("tr");
                  row.innerHTML = `
                    <td>${displayId}</td>
                    <td>${model}</td>
                    <td>${repair}</td>
                    <td>${price}</td>
                    <td>${formattedTime}</td>
                    <td>${datePart}</td>
                  `;
                  tableBody.appendChild(row);
                }
              }
            });

            // Reset the form after submission
            document.getElementById("productForm").reset();
          } catch (error) {
            console.error("Error:", error);
            document.querySelector("#responseTable tbody").innerHTML =
              "<tr><td colspan='6'>Failed to fetch data</td></tr>";
          }
        });

      // Form submission handler for clearing by ID
      document
        .getElementById("clearForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();

          const id = document.getElementById("id").value;

          try {
            const response = await fetch(
              "https://9j78inyh6g.execute-api.us-east-1.amazonaws.com/dev",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  type: "deleteProduct",
                  id,
                }), // Specify type as deleteProduct
              }
            );

            const result = await response.json();
            const body = JSON.parse(result.body);
            let fileContent = body.fileContent;

            // Split the content into lines and reverse the order
            const lines = fileContent.split("\n").reverse();

            // Clear the table body
            const tableBody = document.querySelector("#responseTable tbody");
            tableBody.innerHTML = "";

            // Populate the table
            lines.forEach((line) => {
              if (line.trim()) {
                // Skip empty lines
                const [id, date, model, price, repair] = line.split(",");
                const displayId = id ? id : "***"; // Display '***' if id is missing
                if (date && model && price && repair) {
                  const [datePart, timeWithSeconds] = date.split(" ");
                  const formattedTime = formatTimeWithoutSeconds(
                    `${timeWithSeconds} ${date.split(" ")[2]}`
                  ); // Remove seconds and keep AM/PM
                  const row = document.createElement("tr");
                  row.innerHTML = `
                    <td>${displayId}</td>
                    <td>${model}</td>
                    <td>${repair}</td>
                    <td>${price}</td>
                    <td>${formattedTime}</td>
                    <td>${datePart}</td>
                  `;
                  tableBody.appendChild(row);
                }
              }
            });

            // Reset the form after deletion
            document.getElementById("clearForm").reset();
          } catch (error) {
            console.error("Error:", error);
            document.querySelector("#responseTable tbody").innerHTML =
              "<tr><td colspan='6'>Failed to fetch data</td></tr>";
          }
        });

      // Fetch data as soon as the page loads
      window.onload = fetchData;
    </script>
  </body>
</html>
